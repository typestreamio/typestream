syntax = "proto3";

package io.typestream.grpc;

option java_package = "io.typestream.grpc.state_query_service";

option go_package = "github.com/typestreamio/typestream/cli/pkg/state_query_service";

// StateQueryService provides interactive query capabilities for KTable state stores
// from running Kafka Streams jobs. State stores are only queryable when the underlying
// Kafka Streams application is in RUNNING state.
service StateQueryService {
    // Lists all queryable state stores from running Kafka Streams jobs.
    // Only stores from jobs in RUNNING state are included.
    rpc ListStores(ListStoresRequest) returns (ListStoresResponse) {}
    
    // Streams all key-value pairs from a state store with optional pagination.
    // Returns NOT_FOUND if the store doesn't exist, UNAVAILABLE if the job isn't running.
    rpc GetAllValues(GetAllValuesRequest) returns (stream KeyValuePair) {}
    
    // Retrieves a single value from a state store by key.
    // Returns NOT_FOUND if the store doesn't exist, UNAVAILABLE if the job isn't running.
    rpc GetValue(GetValueRequest) returns (GetValueResponse) {}
}

message ListStoresRequest {}

message StoreInfo {
    // The name of the state store (e.g., "job-id-count-store-0")
    string name = 1;
    // The ID of the job that owns this store
    string job_id = 2;
    // Approximate number of entries in the store, -1 if unavailable
    int64 approximate_count = 3;
}

message ListStoresResponse {
    repeated StoreInfo stores = 1;
}

message GetAllValuesRequest {
    // Name of the state store to query
    string store_name = 1;
    // Maximum number of entries to return (default: 100)
    int32 limit = 2;
    // Reserved for future pagination support - not currently implemented
    string from_key = 3;
}

message KeyValuePair {
    // JSON serialization of the key's schema
    string key = 1;
    // String representation of the value (for count operations, this is the count as a string)
    string value = 2;
}

message GetValueRequest {
    // Name of the state store to query
    string store_name = 1;
    // The key to look up (used to construct a DataStream key)
    string key = 2;
}

message GetValueResponse {
    // True if the key was found in the store
    bool found = 1;
    // String representation of the value, empty if not found
    string value = 2;
}
