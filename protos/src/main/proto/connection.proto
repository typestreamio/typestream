syntax = "proto3";

package io.typestream.grpc;

option java_package = "io.typestream.grpc.connection_service";

option go_package = "github.com/typestreamio/typestream/cli/pkg/connection_service";

import "google/protobuf/timestamp.proto";

service ConnectionService {
    // Register a database connection for monitoring
    rpc RegisterConnection(RegisterConnectionRequest) returns (RegisterConnectionResponse) {}

    // Unregister a connection (stop monitoring)
    rpc UnregisterConnection(UnregisterConnectionRequest) returns (UnregisterConnectionResponse) {}

    // Get current status of all monitored connections
    rpc GetConnectionStatuses(GetConnectionStatusesRequest) returns (GetConnectionStatusesResponse) {}

    // Test a connection immediately (one-shot, doesn't register)
    rpc TestConnection(TestConnectionRequest) returns (TestConnectionResponse) {}
}

// Database connection configuration
message DatabaseConnectionConfig {
    string id = 1;
    string name = 2;
    DatabaseType database_type = 3;
    string hostname = 4;              // Hostname for server health checks (e.g., "localhost")
    int32 port = 5;
    string database = 6;
    string username = 7;
    string password = 8;
    string connector_hostname = 9;    // Hostname for Kafka Connect connectors (e.g., "postgres" in Docker)
}

enum DatabaseType {
    DATABASE_TYPE_UNSPECIFIED = 0;
    POSTGRES = 1;
    MYSQL = 2;
}

// Connection status (includes config for UI to use when creating JDBC sinks)
message ConnectionStatus {
    string id = 1;
    string name = 2;
    ConnectionState state = 3;
    string error = 4;
    google.protobuf.Timestamp last_checked = 5;
    DatabaseConnectionConfig config = 6;  // Full config for JDBC sink creation
}

enum ConnectionState {
    CONNECTION_STATE_UNSPECIFIED = 0;
    CONNECTED = 1;
    DISCONNECTED = 2;
    ERROR = 3;
    CONNECTING = 4;
}

// Register connection for monitoring
message RegisterConnectionRequest {
    DatabaseConnectionConfig connection = 1;
}

message RegisterConnectionResponse {
    bool success = 1;
    string error = 2;
    ConnectionStatus status = 3;
}

// Unregister connection
message UnregisterConnectionRequest {
    string connection_id = 1;
}

message UnregisterConnectionResponse {
    bool success = 1;
    string error = 2;
}

// Get all connection statuses
message GetConnectionStatusesRequest {}

message GetConnectionStatusesResponse {
    repeated ConnectionStatus statuses = 1;
}

// Test a connection one-shot
message TestConnectionRequest {
    DatabaseConnectionConfig connection = 1;
}

message TestConnectionResponse {
    bool success = 1;
    string error = 2;
    int64 latency_ms = 3;
}
