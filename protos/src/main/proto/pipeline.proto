syntax = "proto3";

package io.typestream.grpc;

import "job.proto";

option java_package = "io.typestream.grpc.pipeline_service";

option go_package = "github.com/typestreamio/typestream/cli/pkg/pipeline_service";

service PipelineService {
    rpc ValidatePipeline(ValidatePipelineRequest) returns (ValidatePipelineResponse);
    rpc ApplyPipeline(ApplyPipelineRequest) returns (ApplyPipelineResponse);
    rpc ListPipelines(ListPipelinesRequest) returns (ListPipelinesResponse);
    rpc DeletePipeline(DeletePipelineRequest) returns (DeletePipelineResponse);
    rpc PlanPipelines(PlanPipelinesRequest) returns (PlanPipelinesResponse);
}

message PipelineMetadata {
    string name = 1;
    string version = 2;
    string description = 3;
}

message ValidatePipelineRequest {
    PipelineMetadata metadata = 1;
    PipelineGraph graph = 2;
}

message ValidatePipelineResponse {
    bool valid = 1;
    repeated string errors = 2;
    repeated string warnings = 3;
}

message ApplyPipelineRequest {
    PipelineMetadata metadata = 1;
    PipelineGraph graph = 2;
}

message ApplyPipelineResponse {
    bool success = 1;
    string job_id = 2;
    string error = 3;
    PipelineState state = 4;
}

enum PipelineState {
    PIPELINE_STATE_UNSPECIFIED = 0;
    CREATED = 1;
    UPDATED = 2;
    UNCHANGED = 3;
}

message ListPipelinesRequest {}

message PipelineInfo {
    string name = 1;
    string version = 2;
    string description = 3;
    string job_id = 4;
    JobState job_state = 5;
    int64 applied_at = 6;
    PipelineGraph graph = 7;
}

message ListPipelinesResponse {
    repeated PipelineInfo pipelines = 1;
}

message DeletePipelineRequest {
    string name = 1;
}

message DeletePipelineResponse {
    bool success = 1;
    string error = 2;
}

message PipelinePlan {
    PipelineMetadata metadata = 1;
    PipelineGraph graph = 2;
}

message PlanPipelinesRequest {
    repeated PipelinePlan pipelines = 1;
}

enum PipelineAction {
    PIPELINE_ACTION_UNSPECIFIED = 0;
    CREATE = 1;
    UPDATE = 2;
    NO_CHANGE = 3;
    DELETE = 4;
}

message PipelinePlanResult {
    string name = 1;
    PipelineAction action = 2;
    string current_version = 3;
    string new_version = 4;
}

message PlanPipelinesResponse {
    repeated PipelinePlanResult results = 1;
    repeated string errors = 2;
}
