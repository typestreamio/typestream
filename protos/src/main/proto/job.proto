syntax = "proto3";

package io.typestream.grpc;

option java_package = "io.typestream.grpc.job_service";

option go_package = "github.com/typestreamio/typestream/cli/pkg/job_service";

service JobService {
    rpc CreateJob(CreateJobRequest) returns (CreateJobResponse) {}
    rpc CreateJobFromGraph(CreateJobFromGraphRequest) returns (CreateJobResponse) {}
    rpc ListJobs(ListJobsRequest) returns (ListJobsResponse) {}
    rpc CreatePreviewJob(CreatePreviewJobRequest) returns (CreatePreviewJobResponse) {}
    rpc StopPreviewJob(StopPreviewJobRequest) returns (StopPreviewJobResponse) {}
    rpc StreamPreview(StreamPreviewRequest) returns (stream StreamPreviewResponse) {}
    rpc InferGraphSchemas(InferGraphSchemasRequest) returns (InferGraphSchemasResponse) {}
    rpc ListOpenAIModels(ListOpenAIModelsRequest) returns (ListOpenAIModelsResponse) {}
}

message CreateJobRequest {
    string user_id = 1;
    string source = 2;
}

message CreateJobResponse {
    bool success = 1;
    string job_id = 2;
    string error = 3;
    repeated string created_connectors = 4;  // Connector names created for DB sinks
}

enum Encoding {
  STRING = 0;
  NUMBER = 1;
  JSON = 2;
  AVRO = 3;
  PROTOBUF = 4;
}

message JoinTypeProto {
  bool by_key = 1;
  bool is_lookup = 2;
}

message DataStreamProto {
  string path = 1;
}

message PredicateProto {
  string expr = 1;
}

message CountNode {}

message FilterNode {
  bool by_key = 1;
  PredicateProto predicate = 2;
}

message GroupNode {
  string key_mapper_expr = 1;
}

message JoinNode {
  DataStreamProto with = 1;
  JoinTypeProto join_type = 2;
}

message MapNode {
  string mapper_expr = 1;
}

message NoOpNode {}

message ShellSourceNode {
  repeated DataStreamProto data = 1;
}

message StreamSourceNode {
  DataStreamProto data_stream = 1;
  Encoding encoding = 2;
  bool unwrap_cdc = 3;  // Extract 'after' payload from CDC envelope
}

message EachNode {
  string fn_expr = 1;
}

message SinkNode {
  DataStreamProto output = 1;
  Encoding encoding = 2;
}

message GeoIpNode {
  string ip_field = 1;      // Field containing IP address
  string output_field = 2;  // Output field name (default: country_code)
}

message InspectorNode {
  string label = 1;  // Optional label for the inspector
}

message ReduceLatestNode {}

message TextExtractorNode {
  string file_path_field = 1;  // Field containing the file path
  string output_field = 2;     // Output field name (default: text)
}

message EmbeddingGeneratorNode {
  string text_field = 1;     // Field containing text to embed
  string output_field = 2;   // Output field name (default: embedding)
  string model = 3;          // OpenAI model (default: text-embedding-3-small)
}

message OpenAiTransformerNode {
  string prompt = 1;         // User's instruction prompt
  string output_field = 2;   // Output field name (default: ai_response)
  string model = 3;          // OpenAI model ID (default: gpt-4o-mini)
}

message PipelineNode {
  string id = 1;
  oneof node_type {
    CountNode count = 2;
    FilterNode filter = 3;
    GroupNode group = 4;
    JoinNode join = 5;
    MapNode map = 6;
    NoOpNode noop = 7;
    ShellSourceNode shell_source = 8;
    StreamSourceNode stream_source = 9;
    EachNode each = 10;
    SinkNode sink = 11;
    GeoIpNode geo_ip = 12;
    InspectorNode inspector = 13;
    ReduceLatestNode reduce_latest = 14;
    TextExtractorNode text_extractor = 15;
    EmbeddingGeneratorNode embedding_generator = 16;
    OpenAiTransformerNode open_ai_transformer = 17;
  }
}

message PipelineEdge {
  string from_id = 1;
  string to_id = 2;
}

message PipelineGraph {
  repeated PipelineNode nodes = 1;
  repeated PipelineEdge edges = 2;
}

// Configuration for DB sink connectors (credentials resolved server-side)
message DbSinkConfig {
  string node_id = 1;
  string connection_id = 2;        // Server resolves credentials from this
  string table_name = 3;
  string insert_mode = 4;
  string primary_key_fields = 5;
  string intermediate_topic = 6;   // Optional - server auto-generates if empty
}

message CreateJobFromGraphRequest {
  string user_id = 1;
  PipelineGraph graph = 2;
  repeated DbSinkConfig db_sink_configs = 3;  // DB sink configurations
}

message ListJobsRequest {
  string user_id = 1;
}

enum JobState {
  JOB_STATE_UNSPECIFIED = 0;
  STARTING = 1;
  RUNNING = 2;
  STOPPING = 3;
  STOPPED = 4;
  FAILED = 5;
  UNKNOWN = 6;
}

message JobThroughput {
  double messages_per_second = 1;  // Current processing rate (messages/sec)
  int64 total_messages = 2;        // Total messages processed since job start
  double bytes_per_second = 3;     // Current bandwidth consumption (bytes/sec)
  int64 total_bytes = 4;           // Total bytes processed since job start
}

message JobInfo {
  string job_id = 1;
  JobState state = 2;
  int64 start_time = 3;  // Unix timestamp in milliseconds
  PipelineGraph graph = 4;  // Optional: the job's pipeline graph
  JobThroughput throughput = 5;  // Throughput metrics
}

message ListJobsResponse {
  repeated JobInfo jobs = 1;
}

// Preview job messages
message CreatePreviewJobRequest {
  PipelineGraph graph = 1;
  string inspector_node_id = 2;  // Which inspector node triggered this
}

message CreatePreviewJobResponse {
  bool success = 1;
  string job_id = 2;
  string inspect_topic = 3;  // Topic to consume for preview data
  string error = 4;
}

message StopPreviewJobRequest {
  string job_id = 1;
}

message StopPreviewJobResponse {
  bool success = 1;
  string error = 2;
}

message StreamPreviewRequest {
  string job_id = 1;
}

message StreamPreviewResponse {
  string key = 1;
  string value = 2;
  int64 timestamp = 3;
}

// Schema inference messages
message InferGraphSchemasRequest {
  PipelineGraph graph = 1;
}

message InferGraphSchemasResponse {
  map<string, NodeSchemaResult> schemas = 1;
}

message SchemaField {
  string name = 1;
  string type = 2;
}

message NodeSchemaResult {
  repeated string fields = 1;
  repeated SchemaField typed_fields = 2;
  string encoding = 3;
  string error = 4;
}

// OpenAI models listing
message ListOpenAIModelsRequest {}

message OpenAIModel {
  string id = 1;    // e.g. "gpt-4o-mini"
  string name = 2;  // Display name
}

message ListOpenAIModelsResponse {
  repeated OpenAIModel models = 1;
}
