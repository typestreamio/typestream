syntax = "proto3";

package io.typestream.grpc;

option java_package = "io.typestream.grpc.job_service";

option go_package = "github.com/typestreamio/typestream/cli/pkg/job_service";

service JobService {
    rpc CreateJob(CreateJobRequest) returns (CreateJobResponse) {}
    rpc CreateJobFromGraph(CreateJobFromGraphRequest) returns (CreateJobResponse) {}
    rpc ListJobs(ListJobsRequest) returns (ListJobsResponse) {}
    rpc CreatePreviewJob(CreatePreviewJobRequest) returns (CreatePreviewJobResponse) {}
    rpc StopPreviewJob(StopPreviewJobRequest) returns (StopPreviewJobResponse) {}
    rpc StreamPreview(StreamPreviewRequest) returns (stream StreamPreviewResponse) {}
    rpc InferGraphSchemas(InferGraphSchemasRequest) returns (InferGraphSchemasResponse) {}
    rpc ListOpenAIModels(ListOpenAIModelsRequest) returns (ListOpenAIModelsResponse) {}
}

message CreateJobRequest {
    string user_id = 1;
    string source = 2;
}

message CreateJobResponse {
    bool success = 1;
    string job_id = 2;
    string error = 3;
    repeated string created_connectors = 4;  // Connector names created for DB sinks
}

enum Encoding {
  STRING = 0;
  NUMBER = 1;
  JSON = 2;
  AVRO = 3;
  PROTOBUF = 4;
}

message JoinTypeProto {
  bool by_key = 1;
  bool is_lookup = 2;
}

message DataStreamProto {
  string path = 1;
}

message PredicateProto {
  string expr = 1;
}

message CountNode {}

message WindowedCountNode {
  int64 window_size_seconds = 1;  // e.g., 60 for 1-minute windows
}

message FilterNode {
  bool by_key = 1;
  PredicateProto predicate = 2;
}

message GroupNode {
  string key_mapper_expr = 1;
}

message JoinNode {
  DataStreamProto with = 1;
  JoinTypeProto join_type = 2;
}

message MapNode {
  string mapper_expr = 1;
}

message NoOpNode {}

message ShellSourceNode {
  repeated DataStreamProto data = 1;
}

message StreamSourceNode {
  DataStreamProto data_stream = 1;
  Encoding encoding = 2;
  bool unwrap_cdc = 3;  // Extract 'after' payload from CDC envelope
}

message EachNode {
  string fn_expr = 1;
}

message SinkNode {
  DataStreamProto output = 1;
  Encoding encoding = 2;
}

message GeoIpNode {
  string ip_field = 1;      // Field containing IP address
  string output_field = 2;  // Output field name (default: country_code)
}

message InspectorNode {
  string label = 1;  // Optional label for the inspector
}

message ReduceLatestNode {}

message TextExtractorNode {
  string file_path_field = 1;  // Field containing the file path
  string output_field = 2;     // Output field name (default: text)
}

message EmbeddingGeneratorNode {
  string text_field = 1;     // Field containing text to embed
  string output_field = 2;   // Output field name (default: embedding)
  string model = 3;          // OpenAI model (default: text-embedding-3-small)
}

message OpenAiTransformerNode {
  string prompt = 1;         // User's instruction prompt
  string output_field = 2;   // Output field name (default: ai_response)
  string model = 3;          // OpenAI model ID (default: gpt-4o-mini)
}

message PipelineNode {
  string id = 1;
  oneof node_type {
    CountNode count = 2;
    FilterNode filter = 3;
    GroupNode group = 4;
    JoinNode join = 5;
    MapNode map = 6;
    NoOpNode noop = 7;
    ShellSourceNode shell_source = 8;
    StreamSourceNode stream_source = 9;
    EachNode each = 10;
    SinkNode sink = 11;
    GeoIpNode geo_ip = 12;
    InspectorNode inspector = 13;
    ReduceLatestNode reduce_latest = 14;
    TextExtractorNode text_extractor = 15;
    EmbeddingGeneratorNode embedding_generator = 16;
    OpenAiTransformerNode open_ai_transformer = 17;
    WindowedCountNode windowed_count = 18;
  }
}

message PipelineEdge {
  string from_id = 1;
  string to_id = 2;
}

message PipelineGraph {
  repeated PipelineNode nodes = 1;
  repeated PipelineEdge edges = 2;
}

// Configuration for DB sink connectors (credentials resolved server-side)
message DbSinkConfig {
  string node_id = 1;
  string connection_id = 2;        // Server resolves credentials from this
  string table_name = 3;
  string insert_mode = 4;
  string primary_key_fields = 5;
  string intermediate_topic = 6;   // Optional - server auto-generates if empty
}

// Configuration for Weaviate sink connectors
message WeaviateSinkConfig {
  string node_id = 1;
  string connection_id = 2;
  string intermediate_topic = 3;
  string collection_name = 4;
  string document_id_strategy = 5;
  string document_id_field = 6;
  string vector_strategy = 7;
  string vector_field = 8;
  string timestamp_field = 9;       // Optional: field name for timestamp conversion (empty = no transform)
}

// Configuration for Elasticsearch sink connectors
message ElasticsearchSinkConfig {
  string node_id = 1;
  string connection_id = 2;
  string intermediate_topic = 3;
  string index_name = 4;
  string document_id_strategy = 5;    // RECORD_KEY, TOPIC_PARTITION_OFFSET
  string write_method = 6;            // INSERT, UPSERT
  string behavior_on_null_values = 7; // IGNORE, DELETE, FAIL
}

message CreateJobFromGraphRequest {
  string user_id = 1;
  PipelineGraph graph = 2;
  repeated DbSinkConfig db_sink_configs = 3;  // DB sink configurations
  repeated WeaviateSinkConfig weaviate_sink_configs = 4;  // Weaviate sink configurations
  repeated ElasticsearchSinkConfig elasticsearch_sink_configs = 5;  // Elasticsearch sink configurations
}

message ListJobsRequest {
  string user_id = 1;
}

enum JobState {
  JOB_STATE_UNSPECIFIED = 0;
  STARTING = 1;
  RUNNING = 2;
  STOPPING = 3;
  STOPPED = 4;
  FAILED = 5;
  UNKNOWN = 6;
}

message JobThroughput {
  double messages_per_second = 1;  // Current processing rate (messages/sec)
  int64 total_messages = 2;        // Total messages processed since job start
  double bytes_per_second = 3;     // Current bandwidth consumption (bytes/sec)
  int64 total_bytes = 4;           // Total bytes processed since job start
}

message JobInfo {
  string job_id = 1;
  JobState state = 2;
  int64 start_time = 3;  // Unix timestamp in milliseconds
  PipelineGraph graph = 4;  // Optional: the job's pipeline graph
  JobThroughput throughput = 5;  // Throughput metrics
  repeated WeaviateSinkConfig weaviate_sinks = 6;  // Weaviate sink configs for this job
  repeated ElasticsearchSinkConfig elasticsearch_sinks = 7;  // Elasticsearch sink configs for this job
}

message ListJobsResponse {
  repeated JobInfo jobs = 1;
}

// Preview job messages
message CreatePreviewJobRequest {
  PipelineGraph graph = 1;
  string inspector_node_id = 2;  // Which inspector node triggered this
}

message CreatePreviewJobResponse {
  bool success = 1;
  string job_id = 2;
  string inspect_topic = 3;  // Topic to consume for preview data
  string error = 4;
}

message StopPreviewJobRequest {
  string job_id = 1;
}

message StopPreviewJobResponse {
  bool success = 1;
  string error = 2;
}

message StreamPreviewRequest {
  string job_id = 1;
}

message StreamPreviewResponse {
  string key = 1;
  string value = 2;
  int64 timestamp = 3;
}

// Schema inference messages
message InferGraphSchemasRequest {
  PipelineGraph graph = 1;
}

message InferGraphSchemasResponse {
  map<string, NodeSchemaResult> schemas = 1;
}

message SchemaField {
  string name = 1;
  string type = 2;
}

message NodeSchemaResult {
  repeated string fields = 1;
  repeated SchemaField typed_fields = 2;
  string encoding = 3;
  string error = 4;
}

// OpenAI models listing
message ListOpenAIModelsRequest {}

message OpenAIModel {
  string id = 1;    // e.g. "gpt-4o-mini"
  string name = 2;  // Display name
}

message ListOpenAIModelsResponse {
  repeated OpenAIModel models = 1;
}

// ===== User-facing pipeline representation =====
// These messages define the 14-node vocabulary shared across GUI, CLI, and config-as-code.
// The server's PipelineDesugarer converts these into internal PipelineGraph + sink configs.

message KafkaSourceNode {
  string topic_path = 1;
  Encoding encoding = 2;
  bool unwrap_cdc = 3;
}

message PostgresSourceNode {
  string topic_path = 1;
}

message UserFilterNode {
  string expression = 1;
}

message KafkaSinkNode {
  string topic_name = 1;
}

message MaterializedViewNode {
  string group_by_field = 1;
  string aggregation_type = 2;  // "count" or "latest"
  bool enable_windowing = 3;
  int64 window_size_seconds = 4;
}

// User-facing DB sink (mirrors DbSinkConfig without node_id/intermediate_topic)
message DbSinkNode {
  string connection_id = 1;
  string table_name = 2;
  string insert_mode = 3;
  string primary_key_fields = 4;
}

// User-facing Weaviate sink (mirrors WeaviateSinkConfig without node_id/intermediate_topic)
message WeaviateSinkNode {
  string connection_id = 1;
  string collection_name = 2;
  string document_id_strategy = 3;
  string document_id_field = 4;
  string vector_strategy = 5;
  string vector_field = 6;
  string timestamp_field = 7;
}

// User-facing Elasticsearch sink (mirrors ElasticsearchSinkConfig without node_id/intermediate_topic)
message ElasticsearchSinkNode {
  string connection_id = 1;
  string index_name = 2;
  string document_id_strategy = 3;
  string write_method = 4;
  string behavior_on_null_values = 5;
}

message UserPipelineNode {
  string id = 1;
  oneof node_type {
    // Sources
    KafkaSourceNode kafka_source = 2;
    PostgresSourceNode postgres_source = 3;
    // Transforms
    UserFilterNode filter = 4;
    GeoIpNode geo_ip = 5;
    TextExtractorNode text_extractor = 6;
    EmbeddingGeneratorNode embedding_generator = 7;
    OpenAiTransformerNode open_ai_transformer = 8;
    // Sinks
    KafkaSinkNode kafka_sink = 9;
    InspectorNode inspector = 10;
    MaterializedViewNode materialized_view = 11;
    DbSinkNode db_sink = 12;
    WeaviateSinkNode weaviate_sink = 13;
    ElasticsearchSinkNode elasticsearch_sink = 14;
  }
}

message UserPipelineGraph {
  repeated UserPipelineNode nodes = 1;
  repeated PipelineEdge edges = 2;
}
