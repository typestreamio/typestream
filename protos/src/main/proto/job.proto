syntax = "proto3";

package io.typestream.grpc;

option java_package = "io.typestream.grpc.job_service";

option go_package = "github.com/typestreamio/typestream/cli/pkg/job_service";

service JobService {
    rpc CreateJob(CreateJobRequest) returns (CreateJobResponse) {}
    rpc CreateJobFromGraph(CreateJobFromGraphRequest) returns (CreateJobResponse) {}
    rpc ListJobs(ListJobsRequest) returns (ListJobsResponse) {}
}

message CreateJobRequest {
    string user_id = 1;
    string source = 2;
}

message CreateJobResponse {
    bool success = 1;
    string job_id = 2;
    string error = 3;
}

enum Encoding {
  STRING = 0;
  NUMBER = 1;
  JSON = 2;
  AVRO = 3;
  PROTOBUF = 4;
}

message JoinTypeProto {
  bool by_key = 1;
  bool is_lookup = 2;
}

message DataStreamProto {
  string path = 1;
}

message PredicateProto {
  string expr = 1;
}

message CountNode {}

message FilterNode {
  bool by_key = 1;
  PredicateProto predicate = 2;
}

message GroupNode {
  string key_mapper_expr = 1;
}

message JoinNode {
  DataStreamProto with = 1;
  JoinTypeProto join_type = 2;
}

message MapNode {
  string mapper_expr = 1;
}

message NoOpNode {}

message ShellSourceNode {
  repeated DataStreamProto data = 1;
}

message StreamSourceNode {
  DataStreamProto data_stream = 1;
  Encoding encoding = 2;
}

message EachNode {
  string fn_expr = 1;
}

message SinkNode {
  DataStreamProto output = 1;
  Encoding encoding = 2;
}

message PipelineNode {
  string id = 1;
  oneof node_type {
    CountNode count = 2;
    FilterNode filter = 3;
    GroupNode group = 4;
    JoinNode join = 5;
    MapNode map = 6;
    NoOpNode noop = 7;
    ShellSourceNode shell_source = 8;
    StreamSourceNode stream_source = 9;
    EachNode each = 10;
    SinkNode sink = 11;
  }
}

message PipelineEdge {
  string from_id = 1;
  string to_id = 2;
}

message PipelineGraph {
  repeated PipelineNode nodes = 1;
  repeated PipelineEdge edges = 2;
}

message CreateJobFromGraphRequest {
  string user_id = 1;
  PipelineGraph graph = 2;
}

message ListJobsRequest {
  string user_id = 1;
}

enum JobState {
  JOB_STATE_UNSPECIFIED = 0;
  STARTING = 1;
  RUNNING = 2;
  STOPPING = 3;
  STOPPED = 4;
  FAILED = 5;
  UNKNOWN = 6;
}

message JobThroughput {
  double messages_per_second = 1;  // Current processing rate
  int64 total_messages = 2;        // Total messages processed
}

message JobInfo {
  string job_id = 1;
  JobState state = 2;
  int64 start_time = 3;  // Unix timestamp in milliseconds
  PipelineGraph graph = 4;  // Optional: the job's pipeline graph
  JobThroughput throughput = 5;  // Job throughput metrics
}

message ListJobsResponse {
  repeated JobInfo jobs = 1;
}
