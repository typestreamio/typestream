name: Claude Code Review

on:
  workflow_run:
    workflows:
      - "server check"
      - "frontend check"
      - "connectors check"
    types: [completed]

jobs:
  review:
    runs-on: ubuntu-latest
    # Only review PR builds
    if: github.event.workflow_run.event == 'pull_request'

    permissions:
      contents: read
      pull-requests: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            WORKFLOW: ${{ github.event.workflow_run.name }}
            BRANCH: ${{ github.event.workflow_run.head_branch }}
            TEST RESULT: ${{ github.event.workflow_run.conclusion }}
            RUN ID: ${{ github.event.workflow_run.id }}
            WORKFLOW URL: ${{ github.event.workflow_run.html_url }}

            First, find the PR for this branch:
            gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number,title --jq '.[0]'

            If TEST RESULT is "failure":
            - Check the failed logs: gh run view <RUN ID> --log-failed
            - Analyze the test failure - identify root cause and whether it's flaky or a real bug
            - Include this analysis in your review

            Review this pull request focusing on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions.

            Post your review as a PR comment using: gh pr comment <number> --body "your review"

          claude_args: '--allowed-tools "Bash(gh run view:*),Bash(gh run download:*),Bash(gh pr list:*),Bash(gh pr comment:*),Bash(gh pr view:*),Bash(gh pr diff:*),Read,Glob,Grep"'
