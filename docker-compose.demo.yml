# TypeStream Demo Deployment
#
# Uses pre-built images from GHCR (published on each release).
# Watchtower auto-pulls new :latest images and restarts services.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.demo.yml up -d
#
# Access:
#   - http://localhost (or http://<ip> on server)
#   - With domain: DOMAIN=demo.typestream.io docker compose ... (auto HTTPS)
#

volumes:
  weaviate_data:
  elasticsearch_data:
  demo_files:  # Shared volume for demo file uploads

services:
  # Enable demo mode and wire up connections to demo services
  server:
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      TYPESTREAM_DEMO_MODE: "true"
      TYPESTREAM_POSTGRES_HOST: postgres
      TYPESTREAM_WEAVIATE_REST_URL: http://weaviate:8080
      TYPESTREAM_WEAVIATE_GRPC_URL: weaviate:50051
      TYPESTREAM_ELASTICSEARCH_URL: http://elasticsearch:9200
      KAFKA_CONNECT_URL: http://kafka-connect:8083
      TYPESTREAM_CONFIG: |-
        [grpc]
        port=4242
        [sources.kafka.local]
        bootstrapServers="redpanda:9092"
        schemaRegistry.url="http://redpanda:8081"
        fsRefreshRate=10
    volumes:
      - demo_files:/tmp/typestream-files:ro  # Read sample files for TextExtractor
    depends_on:
      weaviate:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy

  kafka-connect:
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Weaviate vector database
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.28.4
    command:
      - --host
      - 0.0.0.0
      - --port
      - '8080'
      - --scheme
      - http
    ports:
      - "8090:8080"   # REST API (external port 8090 to avoid conflict with envoy)
      - "50051:50051" # gRPC
    volumes:
      - weaviate_data:/var/lib/weaviate
    networks:
      - typestream_network
    restart: on-failure:0
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      CLUSTER_HOSTNAME: 'node1'
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/v1/.well-known/ready || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Elasticsearch search engine
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - typestream_network
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - cluster.name=typestream-es
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s

  # Demo data generators (pre-built from GHCR)
  demo-data-coinbase:
    image: ghcr.io/typestreamio/demo-data:latest
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SCHEMA_REGISTRY_URL: http://redpanda:8081
    networks:
      - typestream_network
    command: ["coinbase", "--products", "BTC-USD,ETH-USD"]
    depends_on:
      redpanda:
        condition: service_healthy

  demo-data-wikipedia:
    image: ghcr.io/typestreamio/demo-data:latest
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SCHEMA_REGISTRY_URL: http://redpanda:8081
    networks:
      - typestream_network
    command: ["wikipedia", "--wikis", "enwiki"]
    depends_on:
      redpanda:
        condition: service_healthy

  demo-data-webvisits:
    image: ghcr.io/typestreamio/demo-data:latest
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SCHEMA_REGISTRY_URL: http://redpanda:8081
    networks:
      - typestream_network
    command: ["webvisits", "--rate", "5"]
    depends_on:
      redpanda:
        condition: service_healthy

  # File uploads connector - writes to PostgreSQL, Debezium captures to Kafka
  demo-data-fileuploads:
    image: ghcr.io/typestreamio/demo-data:latest
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SCHEMA_REGISTRY_URL: http://redpanda:8081
      POSTGRES_JDBC_URL: jdbc:postgresql://postgres:5432/demo
      POSTGRES_USER: typestream
      POSTGRES_PASSWORD: typestream
    volumes:
      - demo_files:/tmp/typestream-files  # Creates sample files for TextExtractor
    networks:
      - typestream_network
    command: ["fileuploads", "--rate", "0.5"]
    depends_on:
      postgres:
        condition: service_healthy
      kafka-connect:
        condition: service_healthy

  # Watchtower - auto-updates containers when new images are pushed to GHCR
  # Only watches containers with com.centurylinklabs.watchtower.enable=true label
  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - typestream_network
    command: --label-enable --interval 300 --cleanup
    restart: unless-stopped
