FROM quay.io/debezium/connect:3.4
LABEL org.opencontainers.image.source=https://github.com/typestreamio/typestream

# Debezium 3.4 includes:
# - PostgresConnector for CDC
# - JdbcSinkConnector for database sinks
# - PostgreSQL JDBC driver

# Install Confluent Schema Registry Avro converter
# Debezium 2.0+ doesn't include these - required for TypeStream Avro integration
# Per Debezium docs: https://debezium.io/documentation/reference/stable/configuration/avro.html

ENV CONFLUENT_VERSION=8.1.1
ENV AVRO_VERSION=1.11.3
ENV JACKSON_VERSION=2.14.2
ENV GUAVA_VERSION=32.1.3-jre

USER root

RUN mkdir -p /kafka/connect/avro-converter

# Confluent packages (from packages.confluent.io)
RUN cd /kafka/connect/avro-converter && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/kafka-connect-avro-converter/${CONFLUENT_VERSION}/kafka-connect-avro-converter-${CONFLUENT_VERSION}.jar && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/kafka-connect-avro-data/${CONFLUENT_VERSION}/kafka-connect-avro-data-${CONFLUENT_VERSION}.jar && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/kafka-avro-serializer/${CONFLUENT_VERSION}/kafka-avro-serializer-${CONFLUENT_VERSION}.jar && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/kafka-schema-serializer/${CONFLUENT_VERSION}/kafka-schema-serializer-${CONFLUENT_VERSION}.jar && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/kafka-schema-converter/${CONFLUENT_VERSION}/kafka-schema-converter-${CONFLUENT_VERSION}.jar && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/kafka-schema-registry-client/${CONFLUENT_VERSION}/kafka-schema-registry-client-${CONFLUENT_VERSION}.jar && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/common-config/${CONFLUENT_VERSION}/common-config-${CONFLUENT_VERSION}.jar && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/common-utils/${CONFLUENT_VERSION}/common-utils-${CONFLUENT_VERSION}.jar

# Transitive dependencies (from Maven Central)
RUN cd /kafka/connect/avro-converter && \
    curl -sLO https://repo1.maven.org/maven2/org/apache/avro/avro/${AVRO_VERSION}/avro-${AVRO_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/org/apache/commons/commons-compress/1.26.0/commons-compress-1.26.0.jar && \
    curl -sLO https://repo1.maven.org/maven2/com/google/guava/failureaccess/1.0.2/failureaccess-1.0.2.jar && \
    curl -sLO https://repo1.maven.org/maven2/com/google/guava/guava/${GUAVA_VERSION}/guava-${GUAVA_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/com/eclipsesource/minimal-json/minimal-json/0.9.5/minimal-json-0.9.5.jar && \
    curl -sLO https://repo1.maven.org/maven2/com/google/re2j/re2j/1.7/re2j-1.7.jar && \
    curl -sLO https://repo1.maven.org/maven2/org/yaml/snakeyaml/2.0/snakeyaml-2.0.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/swagger/swagger-annotations/1.6.9/swagger-annotations-1.6.9.jar

# Jackson dependencies
RUN cd /kafka/connect/avro-converter && \
    curl -sLO https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-databind/${JACKSON_VERSION}/jackson-databind-${JACKSON_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-core/${JACKSON_VERSION}/jackson-core-${JACKSON_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-annotations/${JACKSON_VERSION}/jackson-annotations-${JACKSON_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/com/fasterxml/jackson/dataformat/jackson-dataformat-csv/${JACKSON_VERSION}/jackson-dataformat-csv-${JACKSON_VERSION}.jar

# Install Weaviate Kafka Connect Sink connector
# Note: Distributed as a ZIP file, not JAR
ENV WEAVIATE_CONNECTOR_VERSION=0.1.2

RUN mkdir -p /kafka/connect/weaviate-sink && \
    cd /kafka/connect/weaviate-sink && \
    curl -sLO https://github.com/weaviate/kafka-connect-weaviate/releases/download/${WEAVIATE_CONNECTOR_VERSION}/Weaviate-kafka-connect-weaviate-${WEAVIATE_CONNECTOR_VERSION}.zip && \
    unzip -q Weaviate-kafka-connect-weaviate-${WEAVIATE_CONNECTOR_VERSION}.zip && \
    rm Weaviate-kafka-connect-weaviate-${WEAVIATE_CONNECTOR_VERSION}.zip

# Add missing Netty dependencies for Weaviate connector's gRPC client
# The connector includes grpc-netty but not its transitive netty dependencies
ENV NETTY_VERSION=4.1.110.Final
RUN cd /kafka/connect/weaviate-sink/Weaviate-kafka-connect-weaviate-${WEAVIATE_CONNECTOR_VERSION}/lib && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-buffer/${NETTY_VERSION}/netty-buffer-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-codec/${NETTY_VERSION}/netty-codec-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-codec-http/${NETTY_VERSION}/netty-codec-http-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-codec-http2/${NETTY_VERSION}/netty-codec-http2-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-common/${NETTY_VERSION}/netty-common-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-handler/${NETTY_VERSION}/netty-handler-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-resolver/${NETTY_VERSION}/netty-resolver-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-transport/${NETTY_VERSION}/netty-transport-${NETTY_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/io/netty/netty-transport-native-unix-common/${NETTY_VERSION}/netty-transport-native-unix-common-${NETTY_VERSION}.jar

# Install Confluent Elasticsearch Sink connector
ENV ES_CONNECTOR_VERSION=14.1.0

RUN mkdir -p /kafka/connect/elasticsearch-sink && \
    cd /kafka/connect/elasticsearch-sink && \
    curl -sLO https://packages.confluent.io/maven/io/confluent/kafka-connect-elasticsearch/${ES_CONNECTOR_VERSION}/kafka-connect-elasticsearch-${ES_CONNECTOR_VERSION}.jar && \
    curl -sLO https://repo1.maven.org/maven2/org/elasticsearch/client/elasticsearch-rest-client/8.12.0/elasticsearch-rest-client-8.12.0.jar && \
    curl -sLO https://repo1.maven.org/maven2/org/elasticsearch/client/elasticsearch-rest-client-sniffer/8.12.0/elasticsearch-rest-client-sniffer-8.12.0.jar

# Copy connector registration script and custom entrypoint
COPY docker/register-connector.sh /usr/local/bin/register-connector.sh
COPY docker/custom-entrypoint.sh /usr/local/bin/custom-entrypoint.sh
RUN chmod +x /usr/local/bin/register-connector.sh /usr/local/bin/custom-entrypoint.sh

USER 1001

ENTRYPOINT ["/usr/local/bin/custom-entrypoint.sh"]
CMD ["start"]
